#!/usr/bin/env bash

# In Docker without --privileged, runlevel will return 'unknown'; with --privileged, it seems to return a max of 2
required_runlevel=2

function .is-booted() {
  local current_runlevel="$(runlevel | awk '{print $2;}')"
  test "${current_runlevel}" == "${required_runlevel}" -o -z "${current_runlevel}"
  return $?
}

function .await-boot() {
  local i=0
  local iteration
  local max_retries="${1:-10}"
  local sleep_time="${2:-5}"

  # invoke boot scripts because why not?
  ( set +e ; /etc/rc.local )

  while ! .is-booted && [ $i -lt $max_retries ]; do
    iteration=$(($i + 1)) # the nth iteration, one-based

    printf "[%02d/%02d] waiting %ds for system to reach runlevel ${required_runlevel}...\n" \
      $iteration $max_retries $sleep_time

    sleep $sleep_time

    i=$iteration
  done

  if .is-booted ; then
    echo "Host has reached runlevel ${required_runlevel}."
  else
    echo "ERROR: Host failed to reach runlevel ${required_runlevel}." >&2
    return 1
  fi
}

function .main() {
  .await-boot
}

if [[ "${BASH_SOURCE[0]}" == "$0" ]]; then
  set -e
  .main "$@"
fi
